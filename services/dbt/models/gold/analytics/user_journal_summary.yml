version: 2

models:
  - name: user_journal_summary
    description: Aggregated journal metrics and behavior patterns per user
    columns:
      - name: user_id
        description: Primary key - unique identifier for each user
        data_tests:
          - unique
          - not_null
          - relationships:
              arguments:
                to: ref('dim_users')
                field: user_id

      - name: total_journals
        description: Total number of journal entries created by the user
        data_tests:
          - not_null
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: active_days
        description: Number of distinct days the user has journaled
        data_tests:
          - not_null
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"
          - dbt_utils.expression_is_true:
              arguments:
                expression: "<= total_journals"
              config:
                where: "total_journals > 0"

      - name: avg_mood_score
        description: Average mood score across all journal entries

      - name: mood_score_stddev
        description: Standard deviation of mood scores (volatility measure)
        data_tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"
              config:
                where: "mood_score_stddev is not null"

      - name: positive_entries
        description: Count of journal entries with positive sentiment
        data_tests:
          - not_null
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: negative_entries
        description: Count of journal entries with negative sentiment
        data_tests:
          - not_null
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: neutral_entries
        description: Count of journal entries with neutral sentiment
        data_tests:
          - not_null
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: avg_sentiment_score
        description: Average sentiment score across all journal entries

      - name: first_journal_at
        description: Timestamp of the user's first journal entry
        data_tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "<= last_journal_at"
              config:
                where: "first_journal_at is not null and last_journal_at is not null"

      - name: last_journal_at
        description: Timestamp of the user's most recent journal entry

      - name: last_modified_at
        description: Timestamp of the most recently modified journal entry

      - name: positive_percentage
        description: Percentage of journal entries with positive sentiment
        data_tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "between 0 and 100"
              config:
                where: "positive_percentage is not null"

      - name: total_journals_30d
        description: Total number of journal entries created in the last 30 days
        data_tests:
          - not_null
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"
          - dbt_utils.expression_is_true:
              arguments:
                expression: "<= total_journals"
              config:
                where: "total_journals > 0"

      - name: avg_mood_score_30d
        description: Average mood score across journal entries in the last 30 days

      - name: min_mood_score_30d
        description: Minimum mood score in the last 30 days

      - name: max_mood_score_30d
        description: Maximum mood score in the last 30 days

      - name: daily_streak
        description: Current consecutive days with journal entries (resets if no entry yesterday or today)
        data_tests:
          - not_null
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: days_since_last_journal
        description: Number of days since the user's last journal entry
        data_tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"
              config:
                where: "days_since_last_journal is not null"

      - name: days_between_first_and_last_journal
        description: Number of days between first and last journal entry (journal duration span)
        data_tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"
              config:
                where: "days_between_first_and_last_journal is not null"

      - name: journals_per_active_day
        description: Average number of journals written per active day
        data_tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 1"
              config:
                where: "journals_per_active_day is not null"
